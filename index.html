<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kick Anket Göstergesi</title>
    
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>

    <style>
        /* OBS için temel stiller */
        body {
            /* En önemlisi: Arka plan şeffaf olmalı */
            background-color: transparent;
            color: white;
            font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden; 
        }

        #poll-container {
            /* Konumlandırmayı kolaylaştırmak için bir kapsayıcı */
            position: absolute;
            bottom: 50px; 
            left: 20px;   
            width: 450px; 
            
            /* Görünüm stilleri */
            background-color: rgba(10, 10, 20, 0.85); 
            border: 2px solid #53fc18; 
            border-radius: 10px;
            padding: 20px;
            
            /* Metin stilleri */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); 
            
            /* Başlangıçta görünmez yapıp, anket gelince görünür yapacağız */
            opacity: 0;
            transform: translateY(20px); 
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        /* Anket kutusu görünür olduğunda */
        #poll-container.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Anket Sorusu */
        .poll-question {
            font-size: 24px;
            font-weight: bold;
            border-bottom: 2px solid #53fc18;
            padding-bottom: 10px;
            margin-bottom: 15px;
            word-wrap: break-word; 
        }

        /* Anket Seçenekleri */
        .poll-options {
            list-style-type: none;
            padding-left: 0;
            font-size: 20px;
        }

        .poll-options li {
            padding: 5px 0;
            word-wrap: break-word;
        }

        /* Bağlantı durumu veya hatalar için */
        .status-message {
            font-size: 16px;
            color: #aaa;
        }
        .error-message {
            font-size: 16px;
            color: #ff4d4d;
        }

    </style>
</head>
<body>

    <div id="poll-container">
    </div>

    <script>
        // ------- AYARLAR -------
        // Chatroom ID'si
        const KICK_CHATROOM_ID = 7505488;
        
        // Kick'in Pusher (WebSocket) bilgileri
        const PUSHER_APP_KEY = 'eb1d5f283081a78b932c';
        const PUSHER_CLUSTER = 'us-1';
        // ---------------------

        const pollContainer = document.getElementById('poll-container');

        // HTML Güvenliği ve Temizliği için Fonksiyon
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[m];
            });
        }
        
        // !poll "Soru" "Cevap 1" "Cevap 2" formatını ayrıştıran fonksiyon
        function parseAndDisplayPoll(command) {
            console.log("Anket komutu algılandı:", command);
            
            const regex = /"([^"]*)"/g;
            const parts = [...command.matchAll(regex)].map(match => match[1]);

            if (parts.length < 2) {
                console.warn("Geçersiz anket formatı. En az 1 soru ve 1 seçenek gerekli.");
                return;
            }

            const question = parts[0];
            const options = parts.slice(1);

            let pollHTML = `<div class="poll-question">${escapeHTML(question)}</div>`;
            pollHTML += '<ul class="poll-options">';
            
            options.forEach((option, index) => {
                pollHTML += `<li>${index + 1}. ${escapeHTML(option)}</li>`;
            });
            
            pollHTML += '</ul>';

            pollContainer.innerHTML = pollHTML;
            pollContainer.classList.add('visible');
        }

        // Kick chat'ine bağlanmak için ana fonksiyon
        function connectToKickChat() {
            try {
                // Bağlantı durumunu göster
                pollContainer.innerHTML = `<div class="status-message">Chat'e bağlanılıyor... (ID: ${KICK_CHATROOM_ID})</div>`;
                pollContainer.classList.add('visible'); 

                // 1. Adım: Pusher (WebSocket) ile chat'e bağlan
                // HTTP Polling kullanmaya zorla (Ağ kısıtlamalarını aşmak için)
                const pusher = new Pusher(PUSHER_APP_KEY, {
                    cluster: PUSHER_CLUSTER,
                    forceTLS: true,
                    // Bu kısım, kısıtlı ağlarda bağlantı kurmaya yardımcı olur
                    ws: false, 
                    httpHost: 'sockjs-us1.pusher.com',
                    enabledTransports: ['xhr_streaming', 'xhr_polling'] 
                });

                // 2. Adım: Doğrudan Chatroom ID ile kanala abone ol
                const channel = pusher.subscribe(`chat-room.${KICK_CHATROOM_ID}`);

                // Bağlantı başarılı olduğunda
                pusher.connection.bind('connected', () => {
                    console.log("Kick chat'e başarıyla bağlandı!");
                    pollContainer.innerHTML = `<div class="status-message">Bağlantı başarılı! Anket bekleniyor...</div>`;
                    setTimeout(() => {
                        pollContainer.classList.remove('visible');
                        pollContainer.innerHTML = ''; 
                    }, 5000);
                });

                // Bağlantı hatası
                pusher.connection.bind('error', (err) => {
                    console.error("Pusher bağlantı hatası:", err);
                    pollContainer.innerHTML = `<div class="error-message">Hata: Chat'e bağlanılamadı. Ağınızı kontrol edin.</div>`;
                    pollContainer.classList.add('visible');
                });

                // 3. Adım: Yeni chat mesajlarını dinle
                channel.bind('App\\Events\\ChatMessageEvent', (data) => {
                    const messageData = JSON.parse(data.data);
                    
                    const messageContent = messageData.message.trim();

                    // Anket Komutu Kontrolü
                    if (messageContent.startsWith('!poll ')) {
                        parseAndDisplayPoll(messageContent);
                    }
                    
                    // Anketi kapatmak için komut
                    if (messageContent === '!anketkapat' || messageContent === '!endpoll') {
                         pollContainer.classList.remove('visible');
                         setTimeout(() => {
                            pollContainer.innerHTML = '';
                         }, 500); 
                    }
                });

            } catch (error) {
                console.error("Kick chat'e bağlanırken kritik hata oluştu:", error);
                pollContainer.innerHTML = `<div class="error-message">Kritik Hata: Bağlantı başlatılamadı.</div>`;
                pollContainer.classList.add('visible');
            }
        }

        document.addEventListener('DOMContentLoaded', connectToKickChat);

    </script>
</body>
</html>
