<script>
        // ------- AYARLAR -------
        // Senin BULDUĞUN CHATROOM ID'si
        const KICK_CHATROOM_ID = 7505488;
        
        // Kick'in Pusher (WebSocket) bilgileri
        const PUSHER_APP_KEY = 'eb1d5f283081a78b932c';
        const PUSHER_CLUSTER = 'us-1';
        // ---------------------

        const pollContainer = document.getElementById('poll-container');

        // HTML Güvenliği ve Temizliği için Fonksiyon
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[m];
            });
        }
        
        // !poll "Soru" "Cevap 1" "Cevap 2" formatını ayrıştıran fonksiyon
        function parseAndDisplayPoll(command) {
            console.log("Anket komutu algılandı:", command);
            
            // Regex ile tırnak içindeki tüm metinleri buluyoruz
            const regex = /"([^"]*)"/g;
            const parts = [...command.matchAll(regex)].map(match => match[1]);

            if (parts.length < 2) {
                console.warn("Geçersiz anket formatı. En az 1 soru ve 1 seçenek gerekli.");
                return;
            }

            const question = parts[0];
            const options = parts.slice(1);

            // HTML'i oluştur
            let pollHTML = `<div class="poll-question">${escapeHTML(question)}</div>`;
            pollHTML += '<ul class="poll-options">';
            
            options.forEach((option, index) => {
                pollHTML += `<li>${index + 1}. ${escapeHTML(option)}</li>`;
            });
            
            pollHTML += '</ul>';

            pollContainer.innerHTML = pollHTML;
            pollContainer.classList.add('visible');
        }

        // Kick chat'ine bağlanmak için ana fonksiyon
        function connectToKickChat() {
            try {
                // Bağlantı durumunu göster
                pollContainer.innerHTML = `<div class="status-message">Chat'e bağlanılıyor... (ID: ${KICK_CHATROOM_ID})</div>`;
                pollContainer.classList.add('visible'); 

                // 1. Adım: Pusher (WebSocket) ile chat'e bağlan
                const pusher = new Pusher(PUSHER_APP_KEY, {
                    cluster: PUSHER_CLUSTER,
                    forceTLS: true
                });

                // 2. Adım: Doğrudan Chatroom ID ile kanala abone ol
                const channel = pusher.subscribe(`chat-room.${KICK_CHATROOM_ID}`);

                // Bağlantı başarılı olduğunda
                pusher.connection.bind('connected', () => {
                    console.log("Kick chat'e başarıyla bağlandı!");
                    pollContainer.innerHTML = `<div class="status-message">Bağlantı başarılı! Anket bekleniyor...</div>`;
                    // 5 saniye sonra durumu gizle
                    setTimeout(() => {
                        pollContainer.classList.remove('visible');
                        pollContainer.innerHTML = ''; 
                    }, 5000);
                });

                // Bağlantı hatası
                pusher.connection.bind('error', (err) => {
                    console.error("Pusher bağlantı hatası:", err);
                    pollContainer.innerHTML = `<div class="error-message">Hata: Chat'e bağlanılamadı. Kod ve ID'yi kontrol edin.</div>`;
                    pollContainer.classList.add('visible');
                });

                // 3. Adım: Yeni chat mesajlarını dinle
                channel.bind('App\\Events\\ChatMessageEvent', (data) => {
                    const messageData = JSON.parse(data.data);
                    
                    const messageContent = messageData.message.trim();

                    // Anket Komutu Kontrolü
                    if (messageContent.startsWith('!poll ')) {
                        parseAndDisplayPoll(messageContent);
                    }
                    
                    // Anketi kapatmak için komut
                    if (messageContent === '!anketkapat' || messageContent === '!endpoll') {
                         pollContainer.classList.remove('visible');
                         setTimeout(() => {
                            pollContainer.innerHTML = '';
                         }, 500); 
                    }
                });

            } catch (error) {
                console.error("Kick chat'e bağlanırken kritik hata oluştu:", error);
                pollContainer.innerHTML = `<div class="error-message">Kritik Hata: Bağlantı başlatılamadı.</div>`;
                pollContainer.classList.add('visible');
            }
        }

        // Sayfa yüklendiğinde bağlantıyı başlat
        document.addEventListener('DOMContentLoaded', connectToKickChat);

    </script>
